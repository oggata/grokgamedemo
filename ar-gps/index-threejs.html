<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js版GPS対応AR Model Viewer</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #loading-message {
            position: absolute;
            top: 50%;
            width: 100%;
            text-align: center;
            font-size: 18px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 999;
        }
        #instructions {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 999;
        }
        #debug-info {
            position: absolute;
            top: 50px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            font-size: 12px;
            z-index: 999;
            max-width: 80%;
            word-wrap: break-word;
        }
        .ui-button {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            z-index: 999;
            cursor: pointer;
            margin: 5px;
            border-radius: 5px;
        }
        #coordinates-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        .form-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            align-items: center;
        }
        .form-row input {
            padding: 8px;
            border: none;
            border-radius: 3px;
            width: 120px;
            margin: 0 5px;
        }
        .form-row label {
            min-width: 120px;
        }
        .button-row {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        #toggle-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }
        .coordinate-display {
            font-size: 12px;
            margin-bottom: 5px;
        }
        #model-list {
            margin-top: 10px;
        }
        select {
            padding: 8px;
            border: none;
            border-radius: 3px;
            width: 120px;
        }
        .form-row-small {
            display: flex;
            justify-content: flex-start;
            margin: 5px 0;
            align-items: center;
        }
        .form-row-small input {
            width: 60px;
            padding: 5px;
            margin: 0 5px;
        }
        .form-row-small label {
            min-width: 80px;
        }
    </style>
</head>
<body>
    <div id="loading-message">ARエクスペリエンスを読み込み中...</div>
    <div id="instructions">カメラを周囲に向けてGPS座標を設定してください</div>
    <div id="debug-info">デバッグ情報: 初期化中...</div>

    <!-- 座標入力パネルのトグルボタン -->
    <button id="toggle-panel" class="ui-button">座標パネル表示/非表示</button>

    <!-- 座標入力パネル -->
    <div id="coordinates-panel">
        <div class="coordinate-display">
            現在位置: <span id="current-lat">取得中...</span>, <span id="current-lng">取得中...</span>
        </div>
        <div class="form-row">
            <label for="target-lat">目標緯度:</label>
            <input type="number" id="target-lat" step="0.00001" placeholder="緯度">
        </div>
        <div class="form-row">
            <label for="target-lng">目標経度:</label>
            <input type="number" id="target-lng" step="0.00001" placeholder="経度">
        </div>
        <div class="form-row">
            <label for="model-select">モデル選択:</label>
            <select id="model-select">
                <option value="duck">アヒル</option>
                <option value="box">赤い箱</option>
                <option value="sphere">青い球</option>
            </select>
        </div>
        <div class="form-row-small">
            <label for="distance-scale">距離係数:</label>
            <input type="number" id="distance-scale" value="1" step="0.1" min="0.1">
            <label for="model-height">高さ(m):</label>
            <input type="number" id="model-height" value="0" step="0.5">
        </div>
        <div class="form-row-small">
            <label for="model-size">サイズ:</label>
            <input type="number" id="model-size" value="0.5" step="0.1" min="0.1">
            <label for="use-relative">相対位置:</label>
            <input type="checkbox" id="use-relative" checked>
        </div>
        <div class="button-row">
            <button id="use-current-location" class="ui-button">現在位置を使用</button>
            <button id="place-model" class="ui-button">モデルを配置</button>
            <button id="clear-models" class="ui-button">全てクリア</button>
        </div>
        <div class="button-row">
            <button id="place-nearby" class="ui-button">近くに配置(10m)</button>
            <button id="place-test" class="ui-button">テスト配置</button>
        </div>
        <div id="model-list">
            配置済みモデル: <span id="placed-models-count">0</span>
        </div>
    </div>

    <script>
        // Three.jsのシーン設定
        let scene, camera, renderer;
        let arToolkitSource, arToolkitContext;
        let arMarkerControls;
        let placedModels = [];
        let currentPosition = {
            latitude: 0,
            longitude: 0,
            accuracy: 0
        };

        // UI要素の参照
        const debugInfo = document.getElementById('debug-info');
        const loadingMessage = document.getElementById('loading-message');
        const currentLatSpan = document.getElementById('current-lat');
        const currentLngSpan = document.getElementById('current-lng');
        const targetLatInput = document.getElementById('target-lat');
        const targetLngInput = document.getElementById('target-lng');
        const modelSelect = document.getElementById('model-select');
        const useCurrentLocationBtn = document.getElementById('use-current-location');
        const placeModelBtn = document.getElementById('place-model');
        const clearModelsBtn = document.getElementById('clear-models');
        const togglePanelBtn = document.getElementById('toggle-panel');
        const coordinatesPanel = document.getElementById('coordinates-panel');
        const placedModelsCount = document.getElementById('placed-models-count');
        const distanceScaleInput = document.getElementById('distance-scale');
        const modelHeightInput = document.getElementById('model-height');
        const modelSizeInput = document.getElementById('model-size');
        const useRelativeCheckbox = document.getElementById('use-relative');
        const placeNearbyBtn = document.getElementById('place-nearby');
        const placeTestBtn = document.getElementById('place-test');

        // 初期化関数
        function init() {
            // シーンの作成
            scene = new THREE.Scene();

            // カメラの作成
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0);

            // レンダラーの作成
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // AR.jsの初期化
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam'
            });

            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/patt.hiro',
                detectionMode: 'mono_and_matrix',
                matrixCodeType: '3x3'
            });

            // AR.jsの初期化
            arToolkitSource.initialize(function onReady() {
                arToolkitContext.initialize(onCompleted);
            });

            function onCompleted() {
                // カメラの設定
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                arToolkitSource.domElement.addEventListener('resize', function() {
                    camera.aspect = arToolkitSource.domElement.videoWidth / arToolkitSource.domElement.videoHeight;
                    camera.updateProjectionMatrix();
                });
            }

            // 位置情報の取得を開始
            startLocationTracking();

            // アニメーションループの開始
            animate();

            // イベントリスナーの設定
            setupEventListeners();
        }

        // アニメーションループ
        function animate() {
            requestAnimationFrame(animate);

            if (arToolkitSource.ready) {
                arToolkitContext.update(arToolkitSource.domElement);
                scene.visible = camera.visible;
            }

            renderer.render(scene, camera);
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // ウィンドウのリサイズ対応
            window.addEventListener('resize', function() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // 座標パネルの表示/非表示トグル
            togglePanelBtn.addEventListener('click', function() {
                coordinatesPanel.style.display = coordinatesPanel.style.display === 'none' ? 'flex' : 'none';
            });

            // 現在位置を使用ボタン
            useCurrentLocationBtn.addEventListener('click', function() {
                targetLatInput.value = currentPosition.latitude;
                targetLngInput.value = currentPosition.longitude;
                debugInfo.textContent = 'デバッグ情報: 現在位置をターゲットにセット';
            });

            // モデル配置ボタン
            placeModelBtn.addEventListener('click', function() {
                const targetLat = parseFloat(targetLatInput.value);
                const targetLng = parseFloat(targetLngInput.value);
                const selectedModel = modelSelect.value;
                const modelHeight = parseFloat(modelHeightInput.value);
                const modelSize = parseFloat(modelSizeInput.value);

                if (isNaN(targetLat) || isNaN(targetLng)) {
                    alert('有効な緯度経度を入力してください');
                    return;
                }

                placeModel(targetLat, targetLng, selectedModel, modelHeight, modelSize);
            });

            // 近くに配置ボタン
            placeNearbyBtn.addEventListener('click', function() {
                const selectedModel = modelSelect.value;
                const modelHeight = parseFloat(modelHeightInput.value);
                const modelSize = parseFloat(modelSizeInput.value);

                const offsetLat = currentPosition.latitude + 0.00009;
                const offsetLng = currentPosition.longitude;

                placeModel(offsetLat, offsetLng, selectedModel, modelHeight, modelSize);
            });

            // テスト配置ボタン
            placeTestBtn.addEventListener('click', function() {
                const selectedModel = modelSelect.value;
                const modelHeight = parseFloat(modelHeightInput.value);
                const modelSize = parseFloat(modelSizeInput.value);

                placeDirectModel(selectedModel, modelHeight, modelSize);
            });

            // 全モデルクリアボタン
            clearModelsBtn.addEventListener('click', function() {
                clearAllModels();
            });
        }

        // 位置情報の追跡を開始
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                debugInfo.textContent = 'デバッグ情報: 位置情報サービスを利用可能';

                const watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        currentPosition.latitude = position.coords.latitude;
                        currentPosition.longitude = position.coords.longitude;
                        currentPosition.accuracy = position.coords.accuracy;

                        currentLatSpan.textContent = position.coords.latitude.toFixed(6);
                        currentLngSpan.textContent = position.coords.longitude.toFixed(6);

                        debugInfo.textContent = `デバッグ情報: 位置更新 - ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}, 精度: ${position.coords.accuracy.toFixed(1)}m`;

                        if (useRelativeCheckbox.checked) {
                            updateAllModelsPositions();
                        }
                    },
                    function(error) {
                        debugInfo.textContent = `デバッグ情報: 位置情報エラー - ${error.message}`;
                        alert(`位置情報の取得に失敗しました: ${error.message}`);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 27000
                    }
                );
            } else {
                debugInfo.textContent = 'デバッグ情報: 位置情報サービスを利用できません';
                alert('お使いのブラウザは位置情報をサポートしていません。');
            }
        }

        // GPS座標から3D位置を計算
        function calculatePositionFromGPS(targetLat, targetLng, currentLat, currentLng) {
            const scaleFactor = parseFloat(distanceScaleInput.value) || 1.0;
            const latDiff = targetLat - currentLat;
            const lngDiff = targetLng - currentLng;
            const latDistance = latDiff * 111319.9 * scaleFactor;
            const lngDistance = lngDiff * 111319.9 * Math.cos(currentLat * (Math.PI/180)) * scaleFactor;

            return {
                x: lngDistance,
                y: 0,
                z: -latDistance
            };
        }

        // モデルを配置
        function placeModel(latitude, longitude, modelType, height = 0, size = 0.5) {
            const isRelativeMode = useRelativeCheckbox.checked;
            let model;

            switch(modelType) {
                case 'duck':
                    const loader = new THREE.GLTFLoader();
                    loader.load('https://cdn.jsdelivr.net/gh/aframevr/assets@latest/gltfs/duck/Duck.gltf', function(gltf) {
                        model = gltf.scene;
                        model.scale.set(size, size, size);
                        setupModel(model, latitude, longitude, height, 'アヒル');
                    });
                    return;
                case 'box':
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    model = new THREE.Mesh(geometry, material);
                    model.scale.set(size, size, size);
                    break;
                case 'sphere':
                    const sphereGeometry = new THREE.SphereGeometry(0.5, 32, 32);
                    const sphereMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                    model = new THREE.Mesh(sphereGeometry, sphereMaterial);
                    model.scale.set(size, size, size);
                    break;
                default:
                    console.error('Unknown model type:', modelType);
                    return;
            }

            setupModel(model, latitude, longitude, height, modelType === 'box' ? '赤い箱' : '青い球');
        }

        // モデルのセットアップ
        function setupModel(model, latitude, longitude, height, modelName) {
            const position = calculatePositionFromGPS(
                latitude,
                longitude,
                useRelativeCheckbox.checked ? currentPosition.latitude : 0,
                useRelativeCheckbox.checked ? currentPosition.longitude : 0
            );

            position.y = height;
            model.position.set(position.x, position.y, position.z);

            // テキストラベルの追加
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = '24px Arial';
            context.fillStyle = 'white';
            context.fillText(`${modelName} (${latitude.toFixed(6)}, ${longitude.toFixed(6)})`, 0, 24);

            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ map: texture });
            const label = new THREE.Sprite(labelMaterial);
            label.position.set(0, 1.5, 0);
            label.scale.set(2, 1, 1);
            model.add(label);

            scene.add(model);
            placedModels.push({
                model: model,
                latitude: latitude,
                longitude: longitude,
                height: height
            });

            placedModelsCount.textContent = placedModels.length;
            debugInfo.textContent = `モデルを配置しました - ${modelName} at ${latitude}, ${longitude} => 3D位置(${position.x.toFixed(2)}, ${position.y.toFixed(2)}, ${position.z.toFixed(2)})`;
        }

        // 直接3D空間にモデルを配置（テスト用）
        function placeDirectModel(modelType, height = 0, size = 0.5) {
            let model;

            switch(modelType) {
                case 'duck':
                    const loader = new THREE.GLTFLoader();
                    loader.load('https://cdn.jsdelivr.net/gh/aframevr/assets@latest/gltfs/duck/Duck.gltf', function(gltf) {
                        model = gltf.scene;
                        model.scale.set(size, size, size);
                        model.position.set(0, height, -3);
                        setupTestModel(model, 'アヒル');
                    });
                    return;
                case 'box':
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    model = new THREE.Mesh(geometry, material);
                    model.scale.set(size, size, size);
                    model.position.set(0, height, -3);
                    break;
                case 'sphere':
                    const sphereGeometry = new THREE.SphereGeometry(0.5, 32, 32);
                    const sphereMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                    model = new THREE.Mesh(sphereGeometry, sphereMaterial);
                    model.scale.set(size, size, size);
                    model.position.set(0, height, -3);
                    break;
                default:
                    console.error('Unknown model type:', modelType);
                    return;
            }

            setupTestModel(model, modelType === 'box' ? '赤い箱' : '青い球');
        }

        // テストモデルのセットアップ
        function setupTestModel(model, modelName) {
            // テキストラベルの追加
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = '24px Arial';
            context.fillStyle = 'white';
            context.fillText(`${modelName} (テスト配置)`, 0, 24);

            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ map: texture });
            const label = new THREE.Sprite(labelMaterial);
            label.position.set(0, 1.5, 0);
            label.scale.set(2, 1, 1);
            model.add(label);

            scene.add(model);
            placedModels.push({
                model: model,
                latitude: null,
                longitude: null,
                height: model.position.y
            });

            placedModelsCount.textContent = placedModels.length;
            debugInfo.textContent = `テストモデルを配置しました - ${modelName} at 3D位置(0, ${model.position.y}, -3)`;
        }

        // 全モデルの位置を更新
        function updateAllModelsPositions() {
            placedModels.forEach(function(modelData) {
                if (modelData.latitude === null || modelData.longitude === null) {
                    return;
                }

                const position = calculatePositionFromGPS(
                    modelData.latitude,
                    modelData.longitude,
                    currentPosition.latitude,
                    currentPosition.longitude
                );

                position.y = modelData.height;
                modelData.model.position.set(position.x, position.y, position.z);
            });
        }

        // 全モデルをクリア
        function clearAllModels() {
            placedModels.forEach(function(modelData) {
                scene.remove(modelData.model);
            });
            placedModels = [];
            placedModelsCount.textContent = '0';
            debugInfo.textContent = 'デバッグ情報: 全モデルをクリア';
        }

        // 初期化の実行
        init();
    </script>
</body>
</html> 