<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Based AR with AR.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.3.1/aframe-ar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe-extras/6.1.1/aframe-extras.min.js"></script>
    <style>
        #ui-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        input, button {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }

        #status {
            margin-top: 10px;
            color: #333;
        }

        .current-location {
            margin-top: 5px;
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="ui-container">
        <h3>Location Based AR</h3>
        <div>
            <label for="latitude">緯度 (Latitude):</label>
            <input type="number" id="latitude" step="0.000001" placeholder="35.681236">
        </div>
        <div>
            <label for="longitude">経度 (Longitude):</label>
            <input type="number" id="longitude" step="0.000001" placeholder="139.767125">
        </div>
        <button id="go-button">GO</button>
        <button id="use-current-location">現在地を使用</button>
        <div id="status">座標を入力して GOボタンを押してください</div>
        <div class="current-location" id="current-location-display"></div>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
    >
        <a-assets>
            <a-asset-item id="model" src="./Duck.glb"></a-asset-item>
        </a-assets>

        <a-camera gps-projected-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        // Global variables
        let model = null;
        const modelScale = 0.5; // Adjust scale as needed
        
        // DOM elements
        const latInput = document.getElementById('latitude');
        const longInput = document.getElementById('longitude');
        const goButton = document.getElementById('go-button');
        const useCurrentLocationButton = document.getElementById('use-current-location');
        const statusDiv = document.getElementById('status');
        const currentLocationDisplay = document.getElementById('current-location-display');
        
        // Update status message
        function updateStatus(message) {
            statusDiv.textContent = message;
        }
        
        // Get user's current location
        function getCurrentLocation() {
            updateStatus('現在地を取得中...');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        latInput.value = lat;
                        longInput.value = lng;
                        
                        currentLocationDisplay.textContent = `現在地: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        updateStatus('現在地を取得しました。GOを押して3Dモデルを配置してください。');
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        updateStatus('位置情報の取得に失敗しました。手動で座標を入力してください。');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateStatus('お使いのブラウザは位置情報をサポートしていません。手動で座標を入力してください。');
            }
        }
        
        // Create and place 3D model at specified location
        function placeModel(lat, lng) {
            // Remove previous model if exists
            if (model) {
                model.parentNode.removeChild(model);
            }
            
            // Create new entity for the model
            model = document.createElement('a-entity');
            model.setAttribute('gltf-model', '#model');
            model.setAttribute('scale', `${modelScale} ${modelScale} ${modelScale}`);
            model.setAttribute('animation-mixer', '');
            model.setAttribute('gps-projected-entity-place', {
                latitude: lat,
                longitude: lng
            });
            
            // Add model to scene
            document.querySelector('a-scene').appendChild(model);
            
            updateStatus(`3Dモデルを配置しました: 緯度=${lat.toFixed(6)}, 経度=${lng.toFixed(6)}`);
        }
        
        // Handle GO button click
        goButton.addEventListener('click', () => {
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(longInput.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                updateStatus('有効な座標を入力してください');
                return;
            }
            
            placeModel(lat, lng);
        });
        
        // Handle Use Current Location button click
        useCurrentLocationButton.addEventListener('click', getCurrentLocation);
        
        // Initialize with detecting current location
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for AR.js to initialize
            document.querySelector('a-scene').addEventListener('loaded', () => {
                updateStatus('ARが初期化されました。座標を入力するか現在地を取得してください。');
            });
        });

        // Handle AR.js errors
        window.addEventListener('camera-error', () => {
            updateStatus('カメラへのアクセスに失敗しました。カメラへのアクセス許可を確認してください。');
        });
    </script>
</body>
</html>