<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS対応AR Model Viewer</title>
    <!-- A-Frame と AR.js の最新バージョンを使用 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #loading-message {
            position: absolute;
            top: 50%;
            width: 100%;
            text-align: center;
            font-size: 18px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 999;
        }
        #instructions {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 999;
        }
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            font-size: 12px;
            z-index: 999;
        }
        .ui-button {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            z-index: 999;
            cursor: pointer;
            margin: 5px;
            border-radius: 5px;
        }
        #coordinates-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        .form-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            align-items: center;
        }
        .form-row input {
            padding: 8px;
            border: none;
            border-radius: 3px;
            width: 120px;
            margin: 0 5px;
        }
        .form-row label {
            min-width: 120px;
        }
        .button-row {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        #toggle-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }
        .coordinate-display {
            font-size: 12px;
            margin-bottom: 5px;
        }
        #model-list {
            margin-top: 10px;
        }
        select {
            padding: 8px;
            border: none;
            border-radius: 3px;
            width: 120px;
        }
    </style>
</head>
<body>
    <div id="loading-message">ARエクスペリエンスを読み込み中...</div>
    <div id="instructions">カメラを周囲に向けてGPS座標を設定してください</div>
    <div id="debug-info">デバッグ情報: 初期化中...</div>
    
    <!-- ARコンテンツ用のA-Frameシーン -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded>
        
        <!-- アセット -->
        <a-assets>
            <a-asset-item id="duck-model" src="https://cdn.jsdelivr.net/gh/aframevr/assets@latest/gltfs/duck/Duck.gltf"></a-asset-item>
        </a-assets>
        
        <!-- カメラとカーソル -->
        <a-entity camera look-controls wasd-controls position="0 1.6 0">
            <a-entity cursor="fuse: false; rayOrigin: mouse;"></a-entity>
        </a-entity>
        
        <!-- GPSエンティティはスクリプトで動的に追加 -->
        <a-entity id="gps-models-container"></a-entity>
    </a-scene>

    <!-- 座標入力パネルのトグルボタン -->
    <button id="toggle-panel" class="ui-button">座標パネル表示/非表示</button>

    <!-- 座標入力パネル -->
    <div id="coordinates-panel">
        <div class="coordinate-display">
            現在位置: <span id="current-lat">取得中...</span>, <span id="current-lng">取得中...</span>
        </div>
        <div class="form-row">
            <label for="target-lat">目標緯度:</label>
            <input type="number" id="target-lat" step="0.00001" placeholder="緯度">
        </div>
        <div class="form-row">
            <label for="target-lng">目標経度:</label>
            <input type="number" id="target-lng" step="0.00001" placeholder="経度">
        </div>
        <div class="form-row">
            <label for="model-select">モデル選択:</label>
            <select id="model-select">
                <option value="duck">アヒル</option>
                <option value="box">赤い箱</option>
                <option value="sphere">青い球</option>
            </select>
        </div>
        <div class="button-row">
            <button id="use-current-location" class="ui-button">現在位置を使用</button>
            <button id="place-model" class="ui-button">モデルを配置</button>
            <button id="clear-models" class="ui-button">全てクリア</button>
        </div>
        <div id="model-list">
            配置済みモデル: <span id="placed-models-count">0</span>
        </div>
    </div>

    <script>
        // ページの読み込みが完了したら実行
        window.addEventListener('load', function() {
            const scene = document.querySelector('a-scene');
            const debugInfo = document.getElementById('debug-info');
            const loadingMessage = document.getElementById('loading-message');
            const modelsContainer = document.getElementById('gps-models-container');
            
            // UI要素の参照
            const currentLatSpan = document.getElementById('current-lat');
            const currentLngSpan = document.getElementById('current-lng');
            const targetLatInput = document.getElementById('target-lat');
            const targetLngInput = document.getElementById('target-lng');
            const modelSelect = document.getElementById('model-select');
            const useCurrentLocationBtn = document.getElementById('use-current-location');
            const placeModelBtn = document.getElementById('place-model');
            const clearModelsBtn = document.getElementById('clear-models');
            const togglePanelBtn = document.getElementById('toggle-panel');
            const coordinatesPanel = document.getElementById('coordinates-panel');
            const placedModelsCount = document.getElementById('placed-models-count');
            
            // 配置済みモデルを追跡する配列
            let placedModels = [];
            
            debugInfo.textContent = 'デバッグ情報: ページ読み込み完了';
            
            // 現在位置の追跡変数
            let currentPosition = {
                latitude: 0,
                longitude: 0
            };
            
            // 座標パネルの表示/非表示トグル
            togglePanelBtn.addEventListener('click', function() {
                if (coordinatesPanel.style.display === 'none') {
                    coordinatesPanel.style.display = 'flex';
                } else {
                    coordinatesPanel.style.display = 'none';
                }
            });
            
            // AR.jsが読み込まれたときのイベント
            scene.addEventListener('loaded', function() {
                debugInfo.textContent = 'デバッグ情報: A-Frameシーン読み込み完了';
                
                // 位置情報の取得を開始
                startLocationTracking();
                
                // 少し待ってからメッセージを消す
                setTimeout(function() {
                    loadingMessage.style.display = 'none';
                }, 3000);
            });
            
            // 位置情報の追跡を開始
            function startLocationTracking() {
                if ('geolocation' in navigator) {
                    debugInfo.textContent = 'デバッグ情報: 位置情報サービスを利用可能';
                    
                    // 位置情報の監視を開始
                    const watchId = navigator.geolocation.watchPosition(
                        // 成功時のコールバック
                        function(position) {
                            currentPosition.latitude = position.coords.latitude;
                            currentPosition.longitude = position.coords.longitude;
                            
                            // UI更新
                            currentLatSpan.textContent = position.coords.latitude.toFixed(6);
                            currentLngSpan.textContent = position.coords.longitude.toFixed(6);
                            
                            debugInfo.textContent = `デバッグ情報: 位置更新 - ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                        },
                        // エラー時のコールバック
                        function(error) {
                            debugInfo.textContent = `デバッグ情報: 位置情報エラー - ${error.message}`;
                            alert(`位置情報の取得に失敗しました: ${error.message}`);
                        },
                        // オプション
                        {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 27000
                        }
                    );
                } else {
                    debugInfo.textContent = 'デバッグ情報: 位置情報サービスを利用できません';
                    alert('お使いのブラウザは位置情報をサポートしていません。');
                }
            }
            
            // 現在位置を使用ボタンの処理
            useCurrentLocationBtn.addEventListener('click', function() {
                targetLatInput.value = currentPosition.latitude;
                targetLngInput.value = currentPosition.longitude;
                debugInfo.textContent = 'デバッグ情報: 現在位置をターゲットにセット';
            });
            
            // モデル配置ボタンの処理
            placeModelBtn.addEventListener('click', function() {
                const targetLat = parseFloat(targetLatInput.value);
                const targetLng = parseFloat(targetLngInput.value);
                const selectedModel = modelSelect.value;
                
                if (isNaN(targetLat) || isNaN(targetLng)) {
                    alert('有効な緯度経度を入力してください');
                    return;
                }
                
                debugInfo.textContent = `デバッグ情報: モデル配置中 - ${targetLat}, ${targetLng}, タイプ: ${selectedModel}`;
                
                // モデルを配置
                placeModel(targetLat, targetLng, selectedModel);
            });
            
            // 全モデルクリアボタンの処理
            clearModelsBtn.addEventListener('click', function() {
                // 全モデルを削除
                while (placedModels.length > 0) {
                    const modelToRemove = placedModels.pop();
                    modelsContainer.removeChild(modelToRemove);
                }
                
                // カウンター更新
                placedModelsCount.textContent = '0';
                debugInfo.textContent = 'デバッグ情報: 全モデルをクリア';
            });
            
            // 指定座標にモデルを配置する関数
            function placeModel(latitude, longitude, modelType) {
                // GeoJSON形式の座標位置を作成
                const position = {
                    "type": "Point",
                    "coordinates": [longitude, latitude]
                };
                
                // 新しいエンティティを作成
                const entity = document.createElement('a-entity');
                
                // 共通の属性を設定
                entity.setAttribute('look-at', '[camera]');
                
                // モデルタイプごとに異なる属性を設定
                let modelName = '';
                switch(modelType) {
                    case 'duck':
                        entity.setAttribute('gltf-model', '#duck-model');
                        entity.setAttribute('scale', '0.5 0.5 0.5');
                        modelName = 'アヒル';
                        break;
                    case 'box':
                        // 箱のジオメトリを追加
                        const box = document.createElement('a-box');
                        box.setAttribute('color', 'red');
                        box.setAttribute('depth', '1');
                        box.setAttribute('height', '1');
                        box.setAttribute('width', '1');
                        box.setAttribute('scale', '0.5 0.5 0.5'); // 箱のサイズ
                        entity.appendChild(box);
                        modelName = '赤い箱';
                        break;
                    case 'sphere':
                        // 球のジオメトリを追加
                        const sphere = document.createElement('a-sphere');
                        sphere.setAttribute('color', 'blue');
                        sphere.setAttribute('radius', '0.5');
                        sphere.setAttribute('scale', '0.5 0.5 0.5'); // 球のサイズ
                        entity.appendChild(sphere);
                        modelName = '青い球';
                        break;
                    default:
                        console.error('Unknown model type:', modelType);
                        return;
                }
                
                // 座標を説明するテキストを追加
                const text = document.createElement('a-text');
                text.setAttribute('value', `${modelName} (${latitude.toFixed(4)}, ${longitude.toFixed(4)})`);
                text.setAttribute('position', '0 1.5 0');
                text.setAttribute('align', 'center');
                text.setAttribute('color', 'white');
                text.setAttribute('scale', '0.5 0.5 0.5');
                entity.appendChild(text);
                
                // AR.js GPSエンティティを設定
                // 注: こちらは仮想座標を使用しています。実際のAR.jsのGPS位置設定は異なる場合があります
                // 実際の場所から10mごとに1単位の距離に変換（簡易的な方法）
                const distanceLat = (latitude - currentPosition.latitude) * 111319.9;
                const distanceLng = (longitude - currentPosition.longitude) * 111319.9 * Math.cos(currentPosition.latitude * (Math.PI/180));
                
                // 相対的な位置に配置（AR.jsのgps-entityは使わない簡易実装）
                entity.setAttribute('position', `${distanceLng} 0 ${-distanceLat}`);
                
                // モデルコンテナに追加
                modelsContainer.appendChild(entity);
                
                // 配置済みモデルリストに追加
                placedModels.push(entity);
                
                // UIを更新
                placedModelsCount.textContent = placedModels.length;
                
                debugInfo.textContent = `デバッグ情報: モデルを配置しました - ${modelName} at ${latitude}, ${longitude}`;
            }
            
            // ブラウザのGPSアクセス許可要求を表示
            function requestGeolocationPermission() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        // 許可された場合の処理
                        debugInfo.textContent = 'デバッグ情報: 位置情報へのアクセスが許可されました';
                    }, function(error) {
                        // 拒否された場合の処理
                        debugInfo.textContent = `デバッグ情報: 位置情報へのアクセスが拒否されました - ${error.message}`;
                        alert('ARでの位置情報の利用が拒否されました。設定を確認してください。');
                    });
                }
            }
            
            // 初期化時に位置情報へのアクセス許可を要求
            requestGeolocationPermission();
        });
    </script>
</body>
</html>