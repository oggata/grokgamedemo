<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Enhanced 3D Shooter</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Arial', sans-serif;
            background-color: #000;
        }
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            z-index: 100;
        }
        #score { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            color: #00ffaa; 
            font-size: 24px; 
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
            text-shadow: 0 0 5px rgba(0, 255, 170, 0.8);
            font-weight: bold;
            border: 1px solid rgba(0, 255, 170, 0.3);
        }
        #health {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #ff5555;
            font-size: 24px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 85, 85, 0.5);
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.8);
            font-weight: bold;
            border: 1px solid rgba(255, 85, 85, 0.3);
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff3333;
            font-size: 48px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            display: none;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            animation: pulse 2s infinite;
            border: 2px solid rgba(255, 0, 0, 0.5);
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); }
            50% { transform: translate(-50%, -50%) scale(1.05); text-shadow: 0 0 20px rgba(255, 0, 0, 1); }
            100% { transform: translate(-50%, -50%) scale(1); text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); }
        }
        #restart-button {
            margin-top: 30px;
            padding: 15px 30px;
            font-size: 28px;
            cursor: pointer;
            background: linear-gradient(to bottom, #ff3333, #990000);
            border: none;
            border-radius: 8px;
            color: white;
            pointer-events: auto;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        #restart-button:hover {
            background: linear-gradient(to bottom, #ff5555, #cc0000);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 0, 1);
        }
        #level-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #ffcc00;
            font-size: 22px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.8);
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
            font-weight: bold;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }
        #controls-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: #8888ff;
            font-size: 16px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 5px;
            text-align: right;
            text-shadow: 0 0 5px rgba(136, 136, 255, 0.8);
            box-shadow: 0 0 10px rgba(136, 136, 255, 0.5);
            font-weight: bold;
            border: 1px solid rgba(136, 136, 255, 0.3);
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            opacity: 0.7;
            pointer-events: none;
        }
        #boost-meter {
            position: absolute;
            bottom: 70px;
            left: 20px;
            width: 150px;
            height: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            overflow: hidden;
        }
        #boost-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #00ffff, #00ccff);
            border-radius: 10px;
            transition: width 0.2s;
        }
        .power-up-indicator {
            position: absolute;
            top: 70px;
            right: 20px;
            color: #ffff00;
            font-size: 18px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.8);
            display: none;
            animation: glow 1.5s infinite;
            border: 1px solid rgba(255, 255, 0, 0.3);
        }
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
            50% { box-shadow: 0 0 15px rgba(255, 255, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
        }
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000033;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #loading-text {
            color: #ffffff;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 200, 255, 0.8);
        }
        #loading-bar-container {
            width: 50%;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 2px solid #00ccff;
            overflow: hidden;
        }
        #loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #0066ff, #00ffff);
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div id="loading-text">LOADING GAME...</div>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
    </div>

    <div id="ui-container">
        <div id="score">Score: 0</div>
        <div id="health">Health: 100%</div>
        <div id="level-info">Level: 1</div>
        <div id="controls-info">
            移動: 矢印キー<br>
            発射: スペース<br>
            加速: Shift<br>
            一時停止: P
        </div>
        <div id="boost-meter">
            <div id="boost-fill"></div>
        </div>
        <div id="power-up-indicator" class="power-up-indicator">RAPID FIRE</div>
        <div id="game-over">
            GAME OVER<br>
            <span id="final-score">Score: 0</span>
            <div>
                <button id="restart-button">Restart</button>
            </div>
        </div>
        <img id="crosshair" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjkiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIxIiBvcGFjaXR5PSIwLjgiLz4KICAgIDxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjEiIGZpbGw9IiNmZmZmZmYiIG9wYWNpdHk9IjAuOCIvPgogICAgPGxpbmUgeDE9IjMiIHkxPSIxMCIgeDI9IjgiIHkyPSIxMCIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjEiIG9wYWNpdHk9IjAuOCIvPgogICAgPGxpbmUgeDE9IjEyIiB5MT0iMTAiIHgyPSIxNyIgeTI9IjEwIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMSIgb3BhY2l0eT0iMC44Ii8+CiAgICA8bGluZSB4MT0iMTAiIHkxPSIzIiB4Mj0iMTAiIHkyPSI4IiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMSIgb3BhY2l0eT0iMC44Ii8+CiAgICA8bGluZSB4MT0iMTAiIHkxPSIxMiIgeDI9IjEwIiB5Mj0iMTciIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIxIiBvcGFjaXR5PSIwLjgiLz4KPC9zdmc+">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script>
        // ロード画面の表示
        const loadingBar = document.getElementById('loading-bar');
        const loadingScreen = document.getElementById('loading-screen');
        
        // ロードの進行状況をシミュレート
        let loadProgress = 0;
        const loadInterval = setInterval(() => {
            loadProgress += Math.random() * 5;
            if (loadProgress > 100) {
                loadProgress = 100;
                clearInterval(loadInterval);
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
            loadingBar.style.width = loadProgress + '%';
        }, 100);

        // ゲームの状態
        const GAME_STATE = {
            MENU: 0,
            PLAYING: 1,
            PAUSED: 2,
            GAME_OVER: 3
        };
        
        let currentState = GAME_STATE.PLAYING;

        // 設定
        const SETTINGS = {
            bloom: true,
            particles: true,
            shadows: true,
            postProcessing: true,
            highQualityTextures: true
        };

        // テクスチャローダー
        const textureLoader = new THREE.TextureLoader();
        
        // キューブテクスチャローダー
        const cubeTextureLoader = new THREE.CubeTextureLoader();
        
        // シーンの設定
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000040, 0.002);
        
        // スカイボックス
        const skyboxTexture = cubeTextureLoader.load([
            createStarField(), createStarField(),
            createStarField(), createStarField(),
            createStarField(), createStarField()
        ]);
        scene.background = skyboxTexture;
        
        // スターフィールドのデータURLを生成
        function createStarField() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // 背景を暗い青色で塗りつぶす
            ctx.fillStyle = '#000030';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 星を描画
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 1.5;
                const brightness = Math.random() * 0.5 + 0.5;
                
                // グラデーションで星を描画
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
                gradient.addColorStop(0, `rgba(255, 255, 255, ${brightness})`);
                gradient.addColorStop(0.8, `rgba(255, 255, 255, ${brightness * 0.3})`);
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, radius * 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // いくつかより明るい星を追加
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 2 + 1;
                
                // グラデーションで星を描画
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
                gradient.addColorStop(0.3, 'rgba(200, 220, 255, 0.8)');
                gradient.addColorStop(1, 'rgba(200, 220, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, radius * 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            return canvas.toDataURL('image/png');
        }
        
        // カメラの設定
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            alpha: true,
            powerPreference: 'high-performance'
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = SETTINGS.shadows;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.body.appendChild(renderer.domElement);

        // 光源の追加
        const ambientLight = new THREE.AmbientLight(0x202040, 0.3);
        scene.add(ambientLight);

        // メインの指向性ライト
        const directionalLight = new THREE.DirectionalLight(0xaaccff, 1);
        directionalLight.position.set(5, 50, 20);
        directionalLight.castShadow = SETTINGS.shadows;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 500;
        directionalLight.shadow.camera.left = -50;
        directionalLight.shadow.camera.right = 50;
        directionalLight.shadow.camera.top = 50;
        directionalLight.shadow.camera.bottom = -50;
        scene.add(directionalLight);
        
        // プレイヤーを照らすスポットライト
        const playerSpotlight = new THREE.SpotLight(0x00ffff, 0.8, 50, Math.PI / 6, 0.5, 1);
        playerSpotlight.position.set(0, 10, 5);
        playerSpotlight.castShadow = SETTINGS.shadows;
        scene.add(playerSpotlight);
        
        // 地面の作成
        const gridHelper = new THREE.GridHelper(200, 80, 0x0088ff, 0x001133);
        gridHelper.position.y = -10;
        gridHelper.material.opacity = 0.3;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);
        
        // メタリックな地面マテリアル
        const floorGeometry = new THREE.PlaneGeometry(200, 200, 32, 32);
        const floorTexture = textureLoader.load(createGridTexture());
        floorTexture.wrapS = THREE.RepeatWrapping;
        floorTexture.wrapT = THREE.RepeatWrapping;
        floorTexture.repeat.set(20, 20);
        
        // グリッドテクスチャのデータURLを生成
        function createGridTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            // 背景を暗い青色で塗りつぶす
            ctx.fillStyle = '#000022';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // グリッド線を描画
            ctx.strokeStyle = '#006699';
            ctx.lineWidth = 1;
            
            // 水平線
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            
            // 垂直線
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            
            return canvas.toDataURL('image/png');
        }
        
        const floorMaterial = new THREE.MeshStandardMaterial({
            map: floorTexture,
            normalScale: new THREE.Vector2(0.5, 0.5),
            metalness: 0.8,
            roughness: 0.5,
            color: 0x0055aa,
            emissive: 0x001133,
            transparent: true,
            opacity: 0.8
        });
        
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -10;
        floor.receiveShadow = true;
        scene.add(floor);

        // 背景の霧のパーティクルを作成
        const fogParticles = [];
        if (SETTINGS.particles) {
            const particleTexture = textureLoader.load(createParticleTexture());
            
            function createParticleTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, canvas.width / 2
                );
                gradient.addColorStop(0, 'rgba(150, 200, 255, 1)');
                gradient.addColorStop(0.2, 'rgba(100, 150, 255, 0.5)');
                gradient.addColorStop(1, 'rgba(50, 100, 255, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                return canvas.toDataURL('image/png');
            }
            
            const particleGeometry = new THREE.BufferGeometry();
            const particleCount = 200;
            const positionArray = new Float32Array(particleCount * 3);
            const scaleArray = new Float32Array(particleCount);
            
            for (let i = 0; i < particleCount; i++) {
                // 広い範囲にパーティクルを配置
                positionArray[i * 3] = (Math.random() - 0.5) * 200;
                positionArray[i * 3 + 1] = Math.random() * 20 - 5;
                positionArray[i * 3 + 2] = (Math.random() - 0.5) * 200;
                
                // 異なるサイズを設定
                scaleArray[i] = Math.random() * 2 + 0.5;
            }
            
            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positionArray, 3));
            particleGeometry.setAttribute('scale', new THREE.BufferAttribute(scaleArray, 1));
            
            const particleMaterial = new THREE.PointsMaterial({
                size: 2,
                map: particleTexture,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                opacity: 0.3
            });
            
            const particles = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particles);
            
            fogParticles.push(particles);
        }

        // ビル群を作成
        const buildings = [];
        const buildingTextures = {
            windows: textureLoader.load(createBuildingWindowsTexture()),
            metallic: textureLoader.load(createMetallicTexture()),
            concrete: textureLoader.load(createConcreteTexture()),
            normal: textureLoader.load(createNormalMapTexture())
        };
        
        // 窓のテクスチャを生成
        function createBuildingWindowsTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            // 背景を暗い色で塗りつぶす
            ctx.fillStyle = '#222233';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 窓を描画
            const windowSize = 6;
            const windowSpacing = 10;
            const glowProb = 0.3; // 光る窓の確率
            
            for (let y = windowSpacing; y < canvas.height; y += windowSpacing + windowSize) {
                for (let x = windowSpacing; x < canvas.width; x += windowSpacing + windowSize) {
                    const glowing = Math.random() < glowProb;
                    
                    if (glowing) {
                        // 光る窓
                        const gradient = ctx.createLinearGradient(x, y, x + windowSize, y + windowSize);
                        gradient.addColorStop(0, '#aaccff');
                        gradient.addColorStop(1, '#5588dd');
                        ctx.fillStyle = gradient;
                    } else {
                        // 暗い窓
                        ctx.fillStyle = '#112244';
                    }
                    
                    ctx.fillRect(x, y, windowSize, windowSize);
                }
            }
            
            return canvas.toDataURL('image/png');
        }
        
        // メタリックなテクスチャを生成
        function createMetallicTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            // 背景色
            ctx.fillStyle = '#334455';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // メタリックな線を描画
            for (let i = 0; i < 20; i++) {
                const y = Math.random() * canvas.height;
                const height = Math.random() * 3 + 1;
                const alpha = Math.random() * 0.3 + 0.1;
                
                ctx.fillStyle = `rgba(200, 220, 255, ${alpha})`;
                ctx.fillRect(0, y, canvas.width, height);
            }
            
            // メタリックな点を追加
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 2 + 0.5;
                const alpha = Math.random() * 0.5 + 0.2;
                
                ctx.fillStyle = `rgba(200, 220, 255, ${alpha})`;
                ctx.fillRect(x, y, size, size);
            }
            
            return canvas.toDataURL('image/png');
        }
        
        // コンクリートのテクスチャを生成
        function createConcreteTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            // 背景色
            ctx.fillStyle = '#445566';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ノイズを追加
            for (let i = 0; i < 5000; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 1.5 + 0.5;
                const brightness = Math.random() * 20;
                
                ctx.fillStyle = `rgb(${70 + brightness}, ${85 + brightness}, ${100 + brightness})`;
                ctx.fillRect(x, y, size, size);
            }
            
            return canvas.toDataURL('image/png');
        }
        
        // 法線マップテクスチャを生成
        function createNormalMapTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            // デフォルトの法線（Z方向）
            ctx.fillStyle = '#8080ff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ランダムな凹凸を追加
            for (let i = 0; i < 500; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 5 + 2;
                const dir = Math.random() * Math.PI * 2;
                
                // 法線の方向をRGBで表現
                const r = 128 + Math.cos(dir) * 20;
                const g = 128 + Math.sin(dir) * 20;
                const b = 230; // Z方向は少し強め
                
                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2